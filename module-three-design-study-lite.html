<!DOCTYPE html>
<meta charset="utf-8">

<script src="https://d3js.org/d3.v6.js"></script>

<html>
    <body>
        <link rel="stylesheet" href="module-2-data-stories.css">
        <title>
            Energy Consumption
        </title>
        
        <p class="header">
            Module Three: Data Study Lite
        </p>

        <p class="title">
            Where Death Rates Rose the Most During the Pandemic
        </p>

        <p class="credits">
            By Bao-Nhi Vu and Lama Abed.
        </p>
        <div class="chart" id="chart"></div>
        <div class="income-button">
            <button onclick="update(data1)">High Income</button>
            <button onclick="update(data2)">Upper Middle Income</button>
            <button onclick="update(data3)">Lower or Lower Middle Income</button>
        </div>

        <div class="chart" id="chart1"></div>

        <style>
            .circle:hover{
            stroke: black;
            stroke-width: 4px;
            }
            .tooltip {
                opacity: 0;
                position: absolute;
                padding: 10px;
                background-color: white;
                border: 1px solid #ccc;
                border-radius: 5px;
            }
        </style>

        <div class="chart" id="chart2"></div>

    </body>
</html>


<script>
    
    // Chart 1
    var data1 = [
        {group: "Australia", value: -4},
        {group: "Belgium", value: 8},
        {group: "Canada", value: 4},
        {group: "Chile", value: 17},
        {group: "Czech Republic", value: 16},
        {group: "France", value: 7},
        {group: "Germany", value: 11},
        {group: "Greece", value: 8},
        {group: "Italy", value: 12},
        {group: "Japan", value: -1},
        {group: "Netherlands", value: 9},
        {group: "Poland", value: 19},
        {group: "Portugal", value: 9},
        {group: "Romania", value: 20},
        {group: "South Korea", value: 1},
        {group: "Spain", value: 12},
        {group: "Sweden", value: 6},
        {group: "U.K.", value: 12},
        {group: "United States", value: 15}
    ];

    var data2 = [
        {group: "Argentina", value: 12},
        {group: "Azerbaijan", value: 35},
        {group: "Brazil", value: 24},
        {group: "China", value: 0},
        {group: "Colombia", value: 33},
        {group: "Ecuador", value: 51},
        {group: "Guatemala", value: 25},
        {group: "Iraq", value: 20},
        {group: "Jordan", value: 20},
        {group: "Kazakhstan", value: 29},
        {group: "Malaysia", value: 2},
        {group: "Mexico", value: 41},
        {group: "Peru", value: 97},
        {group: "Russia", value: 31},
        {group: "South Africa", value: 23},
        {group: "Thailand", value: 1},
        {group: "Turkey", value: 30}
    ]
    
    var data3 = [
        {group: "Algeria", value: 17},
        {group: "Bolivia", value: 49},
        {group: "Egypt", value: 21},
        {group: "India", value: 26},
        {group: "Indonesia", value: 28},
        {group: "Iran", value: 29},
        {group: "Kenya", value: 2},
        {group: "Philippines", value: 12},
        {group: "Sri Lanka", value: -3},
        {group: "Tunisia", value: 16},
        {group: "Ukraine", value: 17},
        {group: "Uzbekistan", value: 13}
    ];
    
    var margin = {top: 50, right: 50, bottom: 100, left: 50},
        width = 1200 - margin.left - margin.right,
        height = 800 - margin.top - margin.bottom;
    
    var svg = d3.select("#chart")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    
    var x = d3.scaleBand()
        .range([ 0, width ])
        .padding(0.2);
    var xAxis = svg.append("g")
        .attr("transform", "translate(0," + height + ")")
    
    var y = d3.scaleLinear()
        .range([ height, 0]);
    var yAxis = svg.append("g")
        .attr("class", "myYaxis")
    
    function update(data) {
        x.domain(data.map(function(d) { return d.group; }))
        xAxis.call(d3.axisBottom(x))
    
        y.domain([-10, d3.max(data, function(d) { return d.value }) ]);
        yAxis.transition().duration(1000).call(d3.axisLeft(y));
    
        var u = svg.selectAll("rect")
            .data(data)
    
        u
            .enter()
            .append("rect")
            .merge(u)
            .transition()
            .duration(1000)
            .attr("x", function(d) { return x(d.group); })
            .attr("y", function(d) { return y(d.value); })
            .attr("width", x.bandwidth())
            .attr("height", function(d) { return height - y(d.value); })
            .attr("fill", "#69b3a2")
    
        u
            .exit()
            .remove()
    }
    
    update(data1)


    // Chart 2
    var markers = [
            {long: 1.65, lat: 28.03, group: "Lower or Lower-Middle", size: 17, country: "Algeria"},
            {long: -68.11, lat: -16.5, group: "Lower or Lower-Middle", size: 49, country: "Bolivia"},
            {long: 30.80, lat: 26.82, group: "Lower or Lower-Middle", size: 21, country: "Egypt"},
            {long: 78.96, lat: 20.59, group: "Lower or Lower-Middle", size: 26, country: "India"},
            {long: 106.84, lat: -6.20, group: "Lower or Lower-Middle", size: 28, country: "Indonesia"},
            {long: 53.68, lat: 32.42, group: "Lower or Lower-Middle", size: 29, country: "Iran"},
            {long: 36.82, lat: -1.29, group: "Lower or Lower-Middle", size: 2, country: "Kenya"},
            {long: 121.77, lat: 12.87, group: "Lower or Lower-Middle", size: 12, country: "Philippines"},
            {long: 80.77, lat: 7.87, group: "Lower or Lower-Middle", size: -3, country: "Sri-Lanka"},
            {long: 9.53, lat: 33.88, group: "Lower or Lower-Middle", size: 16, country: "Tunisia"},
            {long: 31.16, lat: 48.37, group: "Lower or Lower-Middle", size: 17, country: "Ukraine"},
            {long: 64.58, lat: 41.37, group: "Lower or Lower-Middle", size: 13, country: "Uzbekstan"},
            
            {long: -58.41, lat: -34.61, group: "Upper-Middle", size: 12, country: "Argentina"},
            {long: 49.86, lat: 40.40, group: "Upper-Middle", size: 35, country: "Azerbaijan"},
            {long: -51.92, lat: -14.23, group: "Upper-Middle", size: 24, country: "Brazil"},
            {long: 104.19, lat: 35.86, group: "Upper-Middle", size: 0, country: "China"},
            {long: -74.29, lat: 4.57, group: "Upper-Middle", size: 33, country: "Colombia"},
            {long: -78.18, lat: -1.83, group: "Upper-Middle", size: 51, country: "Ecuador"},
            {long: -90.50, lat: 14.63, group: "Upper-Middle", size: 25, country: "Guatamala"},
            {long: 44.36, lat: 33.31, group: "Upper-Middle", size: 20, country: "Iraq"},
            {long: 35.92, lat: 31.95, group: "Upper-Middle", size: 20, country: "Jordan"},
            {long: 66.92, lat: 48.01, group: "Upper-Middle", size: 29, country: "Kazakhstan"},
            {long: 101.97, lat: 4.21, group: "Upper-Middle", size: 2, country: "Malaysia"},
            {long: -99.13, lat: 19.43, group: "Upper-Middle", size: 41, country: "Mexico"},
            {long: -75.01, lat: -9.19, group: "Upper-Middle", size: 97, country: "Peru"},
            {long: 37.61, lat: 55.75, group: "Upper-Middle", size: 31, country: "Russia"},
            {long: 28.18, lat: -25.74, group: "Upper-Middle", size: 23, country: "South-Africa"},
            {long: 100.50, lat: 13.75, group: "Upper-Middle", size: 1, country: "Thailand"},
            {long: 28.97, lat: 41.00, group: "Upper-Middle", size: 30, country: "Turkey"},

            {long: 133.77, lat: -25.27, group: "High", size: -4, country: "Australia"},
            {long: 4.35, lat: 50.85, group: "High", size: 8, country: "Belgium"},
            {long: -106.34, lat: 56.13, group: "High", size: 4, country: "Canada"},
            {long: -71.54, lat: -35.67, group: "High", size: 17, country: "Chile"},
            {long: 15.47, lat: 49.81, group: "High", size: 16, country: "Czech-Republic"},
            {long: 1.88, lat: 46.60, group: "High", size: 7, country: "France"},
            {long: 10.45, lat: 51.16, group: "High", size: 11, country: "Germany"},
            {long: 21.82, lat: 39.07, group: "High", size: 8, country: "Greece"},
            {long: 12.56, lat: 41.87, group: "High", size: 12, country: "Italy"},
            {long: 138.25, lat: 36.20, group: "High", size: -1, country: "Japan"},
            {long: 5.29, lat: 52.13, group: "High", size: 9, country: "Netherlands"},
            {long: 19.143, lat: 51.91, group: "High", size: 19, country: "Poland"},
            {long: -8.22, lat: 39.39, group: "High", size: 9, country: "Portugal"},
            {long: 24.96, lat: 45.94, group: "High", size: 20, country: "Romania"},
            {long: 127.76, lat: 35.90, group: "High", size: 1, country: "South-Korea"},
            {long: -3.74, lat: 40.46, group: "High", size: 12, country: "Spain"},
            {long: 18.64, lat: 60.12, group: "High", size: 6, country: "Sweden"},
            {long: -3.43, lat: 55.37, group: "High", size: 12, country: "UK"},
            {long: -95.71, lat: 37.09, group: "High", size: 15, country: "United-States"}
        ];

    var width1 = 2200;
    var height1 = 800;

    var svg1 = d3.select("#chart1")
        .append("svg")
        .attr("width", width1)
        .attr("height", height1);

    var projection = d3.geoMercator()
        .center([70, 30])
        .scale(250)
        .translate([width1/2, height1/2]);

    Promise.all([
        d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson"),
        ]).then(([dataGeo]) => {
            var allContinent = d3.map(markers, function (d) {
                return d.group;
            }).keys();

            var color = d3.scaleOrdinal()
                .domain(allContinent)
                .range(d3.schemeCategory10);

            var valueExtent = d3.extent(markers, function (d) {
                return +d.size;
            });

            var size = d3.scaleSqrt()
                .domain(valueExtent)
                .range([0.2, 50]);

            svg1.append("g")
                .selectAll("path")
                .data(dataGeo.features)
                .enter()
                .append("path")
                .attr("fill", "#b8b8b8")
                .attr("d", d3.geoPath()
                    .projection(projection))
                .style("stroke", "black")
                .style("opacity", 0.3);

            svg1.selectAll("myCircles")
                .data(markers.sort(function (a, b) {return +b.size - +a.size;
                }).filter(function (d, i) {
                    return i < 1000;}))
                .enter()
                .append("circle")
                .attr("cx", function (d) {
                    return projection([+d.long, +d.lat])[0];
                })
                .attr("cy", function (d) {
                    return projection([+d.long, +d.lat])[1];
                })
                .attr("r", function (d) {
                    return size(+d.size);
                })
                .style("fill", function (d) {
                    return color(d.group);
                })
                .attr("stroke", function (d) {
                    if (d.size > 2000) {
                        return "black";
                    } else {
                        return "none";
                    }
                })
                .attr("stroke-width", 1)
                .attr("fill-opacity", 0.4)
                .attr("class", "circle")
                .on("mouseover", mouseover)
                .on("mousemove", mousemove)
                .on("mouseleave", mouseleave);
        });

    var Tooltip = d3.select("#chart1")
        .append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

    var mouseover = function (event, d) {
        Tooltip.style("opacity", 1);
    };

    var mousemove = function (event, d) {
        Tooltip
            .html(d.country + "<br>" + "Class: " + d.group + "<br>" + "Death: " + d.size + "%")
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY + 10) + "px");
    };

    var mouseleave = function (event, d) {
        Tooltip.style("opacity", 0);
    };


    // Chart 2
    var data = [
        {num: 1, highIncome: -14000, upperMiddleIncome: 90000, lowerToLowerMiddleIncome: 70000, name: "Australia", name1: "Argentina", name2: "Algeria"}, 
        {num: 2, highIncome: 18000, upperMiddleIncome: 57000, lowerToLowerMiddleIncome: 88000, name: "Belgium", name1: "Azerbaijan", name2: "Bolivia"},
        {num: 3, highIncome: 22000, upperMiddleIncome: 681000, lowerToLowerMiddleIncome: 251000, name: "Canada", name1: "Brazil", name2: "Egypt"}, 
        {num: 4, highIncome: 39000, upperMiddleIncome: -52000, lowerToLowerMiddleIncome: 4741000, name: "Chile", name1: "China", name2: "India"}, 
        {num: 5, highIncome: 37000, upperMiddleIncome: 165000, lowerToLowerMiddleIncome: 1029000, name: "Czech Republic", name1: "Colombia", name2: "Indonesia"}, 
        {num: 6, highIncome: 82000, upperMiddleIncome: 81000, lowerToLowerMiddleIncome: 232000, name: "France", name1: "Ecuador", name2: "Iran"}, 
        {num: 7, highIncome: 195000, upperMiddleIncome: 49000, lowerToLowerMiddleIncome: 12000, name: "Germany", name1: "Guatemala", name2: "Kenya"}, 
        {num: 8, highIncome: 19000, upperMiddleIncome: 67000, lowerToLowerMiddleIncome: 185000, name: "Greece", name1: "Iraq", name2: "Philippines"}, 
        {num: 9, highIncome: 161000, upperMiddleIncome: 12000, lowerToLowerMiddleIncome: -9000, name: "Italy", name1: "Jordan", name2: "Sri Lanka"}, 
        {num: 10, highIncome: -19000, upperMiddleIncome: 76000, lowerToLowerMiddleIncome: 24000, name: "Japan", name1: "Kazakhstan", name2: "Tunisia"}, 
        {num: 11, highIncome: 29000, upperMiddleIncome: 8000, lowerToLowerMiddleIncome: 198000, name: "Netherlands", name1: "Malaysia", name2: "Ukraine"}, 
        {num: 12, highIncome: 158000, upperMiddleIncome: 626000, lowerToLowerMiddleIncome: 45000, name: "Poland", name1: "Mexico", name2: "Uzbekistan"}, 
        {num: 13, highIncome: 20000, upperMiddleIncome: 290000, lowerToLowerMiddleIncome: 0, name: "Portugal", name1: "Peru", name2: "-"}, 
        {num: 14, highIncome: 107000, upperMiddleIncome: 1072000, lowerToLowerMiddleIncome: 0, name: "Romania", name1: "Russia", name2: "-"}, 
        {num: 15, highIncome: 6000, upperMiddleIncome: 239000, lowerToLowerMiddleIncome: 0, name: "South Korea", name1: "South Africa", name2: "-"}, 
        {num: 16, highIncome: 104000, upperMiddleIncome: 15000, lowerToLowerMiddleIncome: 0, name: "Spain", name1: "Thailand", name2: "-"}, 
        {num: 17, highIncome: 11000, upperMiddleIncome: 264000, lowerToLowerMiddleIncome: 0,  name: "Sweden", name1: "Turkey", name2: "-"}, 
        {num: 18, highIncome: 149000, upperMiddleIncome: 0, lowerToLowerMiddleIncome: 0, name: "U.K.", name1: "-", name2: "-"},
        {num: 19, highIncome: 932000, upperMiddleIncome: 0, lowerToLowerMiddleIncome: 0, name: "United States", name1: "-", name2: "-"}

    ]

    const margin2 = {top: 50, right: 50, bottom: 100, left: 100},
        width2 = 1200 - margin2.left - margin2.right,
        height2 = 800 - margin2.top - margin2.bottom;
    
    const svg2 = d3.select("#chart2")
        .append("svg")
        .attr("width", width2 + margin2.left + margin2.right)
        .attr("height", height2 + margin2.top + margin2.bottom)
        .append("g")
        .attr("transform",
              `translate(${margin2.left}, ${margin2.top})`);
    
    const keys = ["highIncome", "upperMiddleIncome", "lowerToLowerMiddleIncome"];
    
    const color2 = d3.scaleOrdinal()
        .domain(keys)
        .range(d3.schemeCategory10);
    
    const stackedData = d3.stack()
        .keys(keys)
        (data)
    
    const x2 = d3.scaleLinear()
        .domain(d3.extent(data, function(d) { return d.num; }))
        .range([ 0, width2 ])
        
    const xAxis2 = svg2.append("g")
        .attr("transform", `translate(0, ${height2})`)
        .call(d3.axisBottom(x2).ticks(19));

    svg2.append("text")
        .attr("text-anchor", "end")
        .attr("x", width2)
        .attr("y", height2+40 )
        .text("Name of Country");
    
    const y2 = d3.scaleLinear()
        .domain([-100000, 5000000])
        .range([ height2, 0 ]);
     
    svg2.append("g")
        .call(d3.axisLeft(y2).ticks(10))
    
    svg2.append("text")
        .attr("text-anchor", "end")
        .attr("x", 0)
        .attr("y", -20 )
        .text("Total Number of Deaths")
        .attr("text-anchor", "start")    
    
    
    // ClipPath: everything outside this area won't be drawn
    const clip = svg2.append("defs").append("svg:clipPath")
        .attr("id", "clip")
        .append("svg:rect")
        .attr("width", width2 )
        .attr("height", height2 )
        .attr("x", 0)
        .attr("y", 0);
    
    // Add brushing
    const brush = d3.brushX()
        .extent( [ [0,0], [width2,height2] ] )
        .on("end", updateChart)
    
    // Create the scatter variable: where both the circles and the brush take place
    const areaChart = svg2.append('g')
        .attr("clip-path", "url(#clip)")
    
    // Area generator
    const area = d3.area()
        .x(function(d) { return x2(d.data.num); })
        .y0(function(d) { return y2(d[0]); })
        .y1(function(d) { return y2(d[1]); })
    
    // Show the areas
    areaChart
        .selectAll("mylayers")
        .data(stackedData)
        .join("path")
        .attr("class", function(d) { return "myArea " + d.key })
        .style("fill", function(d) { return color2(d.key); })
        .attr("d", area)
    
    // Add the brushing
    areaChart
        .append("g")
        .attr("class", "brush")
        .call(brush);
    
    let idleTimeout
    function idled() { idleTimeout = null; }
    
    // A function that update the chart for given boundaries
    function updateChart(event,d) {
    
        extent = event.selection
    
        // If no selection, back to initial coordinate. Otherwise, update X axis domain
        if (!extent) {
            if (!idleTimeout) return idleTimeout = setTimeout(idled, 350);
                x2.domain(d3.extent(data, function(d) { return d.num; }))
            } else {
                x2.domain([ x2.invert(extent[0]), x2.invert(extent[1]) ])
                areaChart.select(".brush").call(brush.move, null)
            }
    
        // Update axis and area position
        xAxis2.transition().duration(1000).call(d3.axisBottom(x2).ticks(19))
        areaChart
            .selectAll("path")
            .transition().duration(1000)
            .attr("d", area)
    }
    
    const classToPropertyMap = {
        highIncome: 'name',
        upperMiddleIncome: 'name1',
        lowerToLowerMiddleIncome: 'name2',
    };

    // Modify the highlight function
    const highlight = function(event, className) {
        d3.selectAll(".myArea").style("opacity", 0.1);
        d3.select("." + className).style("opacity", 1);

        const propertyName = classToPropertyMap[className];
        if (propertyName) {
            xAxis2.call(d3.axisBottom(x2).ticks(19).tickFormat(function (d) {
                const dataPoint = data.find(item => item.num === d);
                if (dataPoint) {
                    return dataPoint[propertyName];
                } else {
                    return "";
                }
            }));
        }
    };
    
    // And when it is not hovered anymore
    const noHighlight = function(event,d){
        d3.selectAll(".myArea").style("opacity", 1)
        xAxis2.call(d3.axisBottom(x2).ticks(19));
    }

    // Add one dot in the legend for each name.
    const size = 20
    svg2.selectAll(".myrect")
        .data(keys)
        .join("rect")
        .attr("x", 800)
        .attr("y", function(d,i){ return 10 + i*(size+5)}) // 100 is where the first dot appears. 25 is the distance between dots
        .attr("width", size)
        .attr("height", size)
        .style("fill", function(d){ return color2(d)})
        .on("mouseover", highlight)
        .on("mouseleave", noHighlight)

    // Add one dot in the legend for each name.
    svg2.selectAll(".mylabels")
    .data(keys)
    .join("text")
    .attr("x", 800 + size * 1.2)
    .attr("y", function (d, i) { return 10 + i * (size + 5) + (size / 2) }) // 100 is where the first dot appears. 25 is the distance between dots
    .style("fill", function (d) { return color2(d) })
    .text(function (d) {
        if (d === "highIncome") return "High Income";
        if (d === "upperMiddleIncome") return "Upper Middle Income";
        if (d === "lowerToLowerMiddleIncome") return "Lower to Lower Middle Income";
    })
    .attr("text-anchor", "left")
    .style("alignment-baseline", "middle")
    .on("mouseover", highlight)
    .on("mouseleave", noHighlight)
    
</script>